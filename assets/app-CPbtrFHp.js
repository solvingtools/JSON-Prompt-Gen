import"./modulepreload-polyfill-B5Qt9EMX.js";/* empty css              *//* empty css             */import{A as ft,D as Mt}from"./analyticsService-KQK13l_m.js";const Rt=()=>{console.log("Initializing History Sidebars...");const f=document.getElementById("history-sidebar"),t=document.getElementById("history-sidebar-overlay"),i=document.getElementById("history-hamburger-btn"),a=document.getElementById("history-sidebar-close"),d=document.getElementById("history-list");function v(){console.log("Opening History Modal Sidebar"),f&&f.classList.add("active"),t&&t.classList.add("active"),window.gaTracker&&window.gaTracker.trackEvent("history_sidebar_open",{type:"modal"})}function h(){console.log("Closing History Modal Sidebar"),f&&f.classList.remove("active"),t&&t.classList.remove("active")}i&&i.addEventListener("click",v),a&&a.addEventListener("click",h),t&&t.addEventListener("click",h),d&&d.addEventListener("click",function(x){x.target.closest(".history-item")&&!x.target.closest(".history-delete-btn")&&setTimeout(h,150)});const g=document.getElementById("history-section-sidebar"),y=document.getElementById("history-section-sidebar-overlay"),b=document.getElementById("history-section-hamburger-btn"),L=document.getElementById("history-section-sidebar-close"),T=document.getElementById("history-section-list");function _(){console.log("Opening History Section Sidebar"),g&&g.classList.add("active"),y&&y.classList.add("active"),window.gaTracker&&window.gaTracker.trackEvent("history_sidebar_open",{type:"section"})}function V(){console.log("Closing History Section Sidebar"),g&&g.classList.remove("active"),y&&y.classList.remove("active")}b&&b.addEventListener("click",_),L&&L.addEventListener("click",V),y&&y.addEventListener("click",V),T&&T.addEventListener("click",function(x){x.target.closest(".history-item")&&!x.target.closest(".history-delete-btn")&&setTimeout(V,150)}),window.historysSidebarController={open:v,close:h,openSection:_,closeSection:V},console.log("History sidebars initialized (modal + section)")};Rt();const $t={ALGORITHM:"AES-GCM",KEY_LENGTH:256,IV_LENGTH:12,SALT_LENGTH:16,ITERATIONS:1e5,async deriveKey(f,t){const i=new TextEncoder,a=await crypto.subtle.importKey("raw",i.encode(f),"PBKDF2",!1,["deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:t,iterations:this.ITERATIONS,hash:"SHA-256"},a,{name:this.ALGORITHM,length:this.KEY_LENGTH},!1,["encrypt","decrypt"])},async encrypt(f,t){const i=new TextEncoder,a=crypto.getRandomValues(new Uint8Array(this.SALT_LENGTH)),d=crypto.getRandomValues(new Uint8Array(this.IV_LENGTH)),v=await this.deriveKey(t,a),h=await crypto.subtle.encrypt({name:this.ALGORITHM,iv:d},v,i.encode(f)),g=new Uint8Array(a.length+d.length+h.byteLength);return g.set(a,0),g.set(d,a.length),g.set(new Uint8Array(h),a.length+d.length),this.arrayBufferToBase64(g)},async decrypt(f,t){const i=new TextDecoder,a=this.base64ToArrayBuffer(f),d=a.slice(0,this.SALT_LENGTH),v=a.slice(this.SALT_LENGTH,this.SALT_LENGTH+this.IV_LENGTH),h=a.slice(this.SALT_LENGTH+this.IV_LENGTH),g=await this.deriveKey(t,d);try{const y=await crypto.subtle.decrypt({name:this.ALGORITHM,iv:v},g,h);return i.decode(y)}catch{throw new Error("Decryption failed. Invalid password or corrupted data.")}},async getDeviceFingerprint(){var f;try{const i=[navigator.userAgent,navigator.language,screen.width+"x"+screen.height,new Date().getTimezoneOffset().toString(),((f=navigator.hardwareConcurrency)==null?void 0:f.toString())||"unknown"].join("|"),a=new TextEncoder,d=await crypto.subtle.digest("SHA-256",a.encode(i));return this.arrayBufferToBase64(new Uint8Array(d))}catch{return"default_device_salt_"+window.location.origin}},arrayBufferToBase64(f){let t="";const i=new Uint8Array(f);for(let a=0;a<i.byteLength;a++)t+=String.fromCharCode(i[a]);return btoa(t)},base64ToArrayBuffer(f){const t=atob(f),i=new Uint8Array(t.length);for(let a=0;a<t.length;a++)i[a]=t.charCodeAt(a);return i}};class Gt{constructor(){this.STORAGE_KEY="llm_vault",this.providers={openai:{name:"OpenAI",models:[{id:"gpt-5.2-pro",name:"GPT-5.2 Pro (Recommended)",maxTokens:4096},{id:"o4-mini",name:"o4-mini",maxTokens:4096},{id:"gpt-4.1-mini",name:"GPT-4.1 mini",maxTokens:4096},{id:"gpt-4.5",name:"GPT-4.5",maxTokens:4096}],endpoint:"https://api.openai.com/v1/chat/completions",validateEndpoint:"https://api.openai.com/v1/models"},anthropic:{name:"Anthropic",models:[{id:"claude-opus-4.5",name:"Claude Opus 4.5 (Recommended)",maxTokens:4096},{id:"claude-sonnet-4.5",name:"Claude Sonnet 4.5",maxTokens:4096},{id:"claude-opus-4.1",name:"Claude Opus 4.1",maxTokens:4096},{id:"claude-haiku-4.5",name:"Claude Haiku 4.5",maxTokens:4096}],endpoint:"https://api.anthropic.com/v1/messages"},gemini:{name:"Gemini",models:[{id:"gemini-3-pro",name:"Gemini 3 Pro (Recommended)",maxTokens:8192},{id:"gemini-2.5-pro",name:"Gemini 2.5 Pro",maxTokens:8192},{id:"gemini-3-flash",name:"Gemini 3 Flash",maxTokens:8192},{id:"gemini-2.5-flash-lite",name:"Gemini 2.5 Flash-Lite",maxTokens:8192}],endpoint:"https://generativelanguage.googleapis.com/v1beta/models"}},this.activeProvider=null,this.config={}}async init(){await this.loadConfig()}async loadConfig(){try{const t=localStorage.getItem(this.STORAGE_KEY);if(t){const i=await CryptoUtils.getDeviceFingerprint(),a=await CryptoUtils.decrypt(t,i);this.config=JSON.parse(a)}}catch(t){console.warn("LLMService: Could not load config, starting fresh.",t.message),this.config={}}}async saveConfig(){try{const t=await CryptoUtils.getDeviceFingerprint(),i=await CryptoUtils.encrypt(JSON.stringify(this.config),t);localStorage.setItem(this.STORAGE_KEY,i)}catch(t){console.error("LLMService: Failed to save config.",t)}}async setProviderKey(t,i,a){if(!this.providers[t])throw new Error(`Unknown provider: ${t}`);this.config[t]={key:i,model:a||this.providers[t].models[0].id,lastUsed:null,requestCount:0},await this.saveConfig()}getProviderKey(t){var i;return((i=this.config[t])==null?void 0:i.key)||null}async removeProvider(t){delete this.config[t],await this.saveConfig()}getConfiguredProviders(){return Object.keys(this.config).filter(t=>{var i;return(i=this.config[t])==null?void 0:i.key})}async validateKey(t,i){try{switch(t){case"openai":return await this._validateOpenAI(i);case"anthropic":return await this._validateAnthropic(i);case"gemini":return await this._validateGemini(i);default:return{valid:!1,message:"Unknown provider"}}}catch(a){return{valid:!1,message:a.message}}}async _validateOpenAI(t){var d;const i=await fetch(this.providers.openai.validateEndpoint,{method:"GET",headers:{Authorization:`Bearer ${t}`}});return i.ok?{valid:!0,message:"API key is valid!"}:{valid:!1,message:((d=(await i.json()).error)==null?void 0:d.message)||"Invalid API key"}}async _validateAnthropic(t){var d;const i=await fetch(this.providers.anthropic.endpoint,{method:"POST",headers:{"x-api-key":t,"anthropic-version":"2023-06-01","content-type":"application/json","anthropic-dangerous-direct-browser-access":"true"},body:JSON.stringify({model:"claude-3-5-haiku-20241022",max_tokens:10,messages:[{role:"user",content:"Hi"}]})});return i.ok?{valid:!0,message:"API key is valid!"}:{valid:!1,message:((d=(await i.json()).error)==null?void 0:d.message)||"Invalid API key"}}async _validateGemini(t){var v;const i=`${this.providers.gemini.endpoint}?key=${t}`,a=await fetch(i);return a.ok?{valid:!0,message:"API key is valid!"}:{valid:!1,message:((v=(await a.json()).error)==null?void 0:v.message)||"Invalid API key"}}async generatePrompt(t,i,a={}){const d=this.config[t];if(!(d!=null&&d.key))throw new Error(`No API key configured for ${t}`);const v=this._buildSystemPrompt(a.modelProfile||null),h=this._buildUserPrompt(i);let g;switch(t){case"openai":g=await this._callOpenAI(d.key,d.model,v,h,a);break;case"anthropic":g=await this._callAnthropic(d.key,d.model,v,h,a);break;case"gemini":g=await this._callGemini(d.key,d.model,v,h,a);break;default:throw new Error("Unknown provider")}return d.lastUsed=new Date().toISOString(),d.requestCount=(d.requestCount||0)+1,await this.saveConfig(),this._cleanResponse(g)}_cleanResponse(t){return t?t.replace(/^(Prompt|Enhanced Prompt|Result|Response|Scene \d+|Output|Description):?\s*/i,"").replace(/^["'](.*)["']$/s,"$1").trim():""}async generateFullJson(t,i,a={}){const d=this.config[t];if(!(d!=null&&d.key))throw new Error(`No API key configured for ${t}`);const v=`You are a specialized AI for generating professional VEO video prompts in strict JSON format.
        
Your task is to take the user's rough scene inputs and transform them into a polished, cinematic JSON output.
Follow these rules strictly:
1. Output MUST be a valid JSON array of objects.
2. Each object must follow this schema:
   {
     "description": "Enhanced, detailed cinematic description",
     "camera": "Camera angle/movement (keep original if good, or enhance)",
     "lighting": "Lighting style (keep original if good, or enhance)",
     "negative_prompt": "Negative constraints"
   }
3. Enhance the 'description' field to be vivid, detailed, and use professional filmmaking terminology.
4. Keep the 'negative_prompt' robust but concise.
5. Do NOT add any markdown formatting (like \`\`\`json). Output raw JSON string only.
6. Maintain the exact number of scenes as the input.
7. Output ONLY the raw JSON content without any conversational filler or "Prompt" labels.`,h=`Here is the raw scene data to enhance and format as JSON:
${JSON.stringify(i,null,2)}`;let g;switch(t){case"openai":g=await this._callOpenAI(d.key,d.model,v,h,a);break;case"anthropic":g=await this._callAnthropic(d.key,d.model,v,h,a);break;case"gemini":g=await this._callGemini(d.key,d.model,v,h,a);break;default:throw new Error("Unknown provider")}return d.lastUsed=new Date().toISOString(),d.requestCount=(d.requestCount||0)+1,await this.saveConfig(),g.replace(/^```json\s*/i,"").replace(/\s*```$/,"").trim()}_buildSystemPrompt(t=null){let i=`You are PromptForge AI, an expert cinematic video prompt engineer. Your role is to enhance user scene descriptions into highly detailed, professional video generation prompts.

Guidelines:
- Incorporate specific cinematic techniques (camera angles, movements, lighting styles)
- Use vivid, evocative language that AI video models understand
- Maintain the user's creative intent while adding professional depth
- Keep responses focused and concise (max 200 words per scene)
- Output ONLY the refined descriptive text.
- DO NOT include labels like "Prompt:", "Enhanced:", or "Scene:".
- DO NOT include any introductory or concluding remarks.`;return t&&(i+=`

**Target Model: ${t.name}**
`,i+=`- ${t.description}
`,t.supportsCameraControls||(i+=`- This model does NOT support advanced camera controls. Avoid describing specific camera movements like "tracking shot" or "crane shot".
`),t.supportsNegativePrompt||(i+=`- This model does NOT support negative prompts. If the user mentions things to avoid, try to express constraints positively or rephrase.
`),i+=`- Allowed Frame Rates: ${t.allowedFrameRates.join(", ")} fps.
`,i+=`- Max Resolution: ${t.maxResolution}.
`),i}_buildUserPrompt(t){let i=`Enhance this scene description for AI video generation:

`;return i+=`Description: ${t.description||"A cinematic scene"}
`,t.camera&&(i+=`Camera: ${t.camera}
`),t.lighting&&(i+=`Lighting: ${t.lighting}
`),t.negative_prompt&&(i+=`Avoid: ${t.negative_prompt}
`),i}async _callOpenAI(t,i,a,d,v){var y;const h=await fetch(this.providers.openai.endpoint,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({model:i,messages:[{role:"system",content:a},{role:"user",content:d}],temperature:v.temperature||.7,max_tokens:v.maxTokens||500})});if(!h.ok){const b=await h.json();throw new Error(((y=b.error)==null?void 0:y.message)||"OpenAI API error")}return(await h.json()).choices[0].message.content}async _callAnthropic(t,i,a,d,v){var y;const h=await fetch(this.providers.anthropic.endpoint,{method:"POST",headers:{"x-api-key":t,"anthropic-version":"2023-06-01","content-type":"application/json","anthropic-dangerous-direct-browser-access":"true"},body:JSON.stringify({model:i,max_tokens:v.maxTokens||500,system:a,messages:[{role:"user",content:d}]})});if(!h.ok){const b=await h.json();throw new Error(((y=b.error)==null?void 0:y.message)||"Anthropic API error")}return(await h.json()).content[0].text}async _callGemini(t,i,a,d,v){var L,T;const h=`${this.providers.gemini.endpoint}/${i}:generateContent?key=${t}`,g=await fetch(h,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{role:"user",parts:[{text:`${a}

${d}`}]}],generationConfig:{temperature:v.temperature||.7,maxOutputTokens:v.maxTokens||500}})});if(!g.ok){const _=await g.json();throw new Error(((L=_.error)==null?void 0:L.message)||"Gemini API error")}const y=await g.json();if(!y.candidates||y.candidates.length===0){const _=((T=y.promptFeedback)==null?void 0:T.blockReason)||"UNKNOWN_REASON";throw new Error(`Gemini blocked the request: ${_}. Please try a slightly different prompt.`)}const b=y.candidates[0];if(!b.content||!b.content.parts||b.content.parts.length===0){const _=b.finishReason||"SAFETY/FILTERING";throw new Error(`Gemini response generation failed: ${_}. The content may have been flagged by safety filters.`)}return b.content.parts[0].text}getUsageStats(){const t={};for(const[i,a]of Object.entries(this.config))a!=null&&a.key&&(t[i]={lastUsed:a.lastUsed,requestCount:a.requestCount||0,model:a.model});return t}}class bt{constructor(){this.STORAGE_KEY="json_prompt_gen_history",this.MAX_ITEMS=50}save(t,i="json"){const a=this.getAll(),d={id:Date.now().toString(36)+Math.random().toString(36).substr(2,5),timestamp:Date.now(),mode:i,content:t,summary:this._generateSummary(t)};return a.unshift(d),a.length>this.MAX_ITEMS&&(a.length=this.MAX_ITEMS),this._persist(a),d}getAll(){try{const t=localStorage.getItem(this.STORAGE_KEY);return t?JSON.parse(t):[]}catch(t){return console.error("Failed to load history:",t),[]}}getById(t){return this.getAll().find(i=>i.id===t)}clear(){localStorage.removeItem(this.STORAGE_KEY)}delete(t){let i=this.getAll();i=i.filter(a=>a.id!==t),this._persist(i)}getDiff(t,i){const a=JSON.stringify(t,null,2),d=JSON.stringify(i,null,2),v=a.split(`
`),h=d.split(`
`);let g="",y=0,b=0;for(;y<v.length||b<h.length;){const L=v[y],T=h[b];L===T?(g+=`<div class="diff-line">${this._escapeHtml(L||"")}</div>`,y++,b++):(L!==void 0&&(g+=`<div class="diff-line diff-remove">- ${this._escapeHtml(L)}</div>`,y++),T!==void 0&&(g+=`<div class="diff-line diff-add">+ ${this._escapeHtml(T)}</div>`,b++))}return g}_generateSummary(t){const i=t.scenes?t.scenes.length:0,a=t.platform||"Unknown";return`${i} Scene${i!==1?"s":""} • ${a}`}_persist(t){try{localStorage.setItem(this.STORAGE_KEY,JSON.stringify(t))}catch(i){if(console.error("Failed to save history:",i),t.length>1){const a=t.slice(0,Math.floor(t.length/2));this._persist(a)}}}_escapeHtml(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}}class Ht{constructor(t){this.analytics=t}async submitFeedback(t,i,a=null){return await new Promise(d=>setTimeout(d,1e3)),this.analytics&&this.analytics.trackEvent("feedback_submitted",{type:t,length:i.length,has_screenshot:!!a}),{success:!0,id:"fb_"+Date.now()}}}class jt{constructor(){this.currentStep=1,this.totalSteps=4,this.modal=document.getElementById("getting-started-modal"),this.closeBtn=document.getElementById("getting-started-close-btn"),this.nextBtn=document.getElementById("getting-started-next"),this.prevBtn=document.getElementById("getting-started-prev"),this.checkbox=document.getElementById("dont-show-again"),this.modal&&this.init()}init(){localStorage.getItem("hasSeenGettingStarted")||setTimeout(()=>this.show(),1e3),this.bindEvents(),window.showGettingStarted=()=>this.show()}show(){this.modal.classList.remove("hidden"),this.currentStep=1,this.updateStep()}hide(){this.modal.classList.add("hidden"),this.checkbox.checked&&localStorage.setItem("hasSeenGettingStarted","true")}updateStep(){document.querySelectorAll(".getting-started-step").forEach(i=>{i.classList.add("hidden")});const t=document.querySelector(`.getting-started-step[data-step="${this.currentStep}"]`);t&&t.classList.remove("hidden"),document.querySelectorAll(".progress-dot").forEach(i=>{const a=parseInt(i.dataset.dot);i.classList.toggle("active",a===this.currentStep)}),this.prevBtn.style.display=this.currentStep===1?"none":"inline-flex",this.nextBtn.textContent=this.currentStep===this.totalSteps?"Get Started":"Next"}next(){this.currentStep<this.totalSteps?(this.currentStep++,this.updateStep()):this.hide()}prev(){this.currentStep>1&&(this.currentStep--,this.updateStep())}bindEvents(){this.closeBtn.addEventListener("click",()=>this.hide()),this.nextBtn.addEventListener("click",()=>this.next()),this.prevBtn.addEventListener("click",()=>this.prev()),document.querySelectorAll(".progress-dot").forEach(t=>{t.addEventListener("click",()=>{this.currentStep=parseInt(t.dataset.dot),this.updateStep()})}),this.modal.addEventListener("click",t=>{t.target===this.modal&&this.hide()})}}class Dt{constructor(){this.profiles={veo:{id:"veo",name:"Google Veo",maxResolution:"1080p",allowedResolutions:["1080p"],allowedAspectRatios:["16:9","9:16","1:1","4:3","21:9"],allowedFrameRates:["24","30"],supportsNegativePrompt:!0,supportsCameraControls:!0,maxPromptLength:500,description:"Google's high-fidelity video generation model aimed at cinematic realism."},sora:{id:"sora",name:"OpenAI Sora",maxResolution:"1080p",allowedResolutions:["1080p"],allowedAspectRatios:["16:9","9:16","1:1","4:3","21:9"],allowedFrameRates:["24","30","60"],supportsNegativePrompt:!1,supportsCameraControls:!0,maxPromptLength:300,description:"OpenAI's physics-simulating video model known for complex motion."},runway:{id:"runway",name:"Runway Gen-3 Alpha",maxResolution:"4K",allowedResolutions:["720p","1080p","4K"],allowedAspectRatios:["16:9","9:16","21:9"],allowedFrameRates:["24","30","60"],supportsNegativePrompt:!1,supportsCameraControls:!0,maxPromptLength:500,description:"Runway's latest model with advanced temporal consistency and realistic motion."},luma:{id:"luma",name:"Luma Dream Machine",maxResolution:"1080p",allowedResolutions:["1080p"],allowedAspectRatios:["16:9","9:16","1:1","4:3"],allowedFrameRates:["24","30"],supportsNegativePrompt:!0,supportsCameraControls:!0,maxPromptLength:400,description:"Fast, high-quality video model optimized for creative workflows."},kling:{id:"kling",name:"Kling",maxResolution:"1080p",allowedResolutions:["1080p"],allowedAspectRatios:["16:9","9:16","1:1"],allowedFrameRates:["30"],supportsNegativePrompt:!0,supportsCameraControls:!0,maxPromptLength:600,description:"Emerging high-motion model with strong character consistency."}}}getProfile(t){return this.profiles[t]||null}getCapability(t,i){const a=this.profiles[t];return a?a[i]:null}validateParams(t,i){const a=this.profiles[t];if(!a)return{valid:!0,violations:[]};const d=[];return i.resolution&&!a.allowedResolutions.includes(i.resolution)&&d.push({param:"resolution",message:`Resolution '${i.resolution}' is not supported by ${a.name}. Supported: ${a.allowedResolutions.join(", ")}`,suggested:a.allowedResolutions[0]}),i.aspectRatio&&!a.allowedAspectRatios.includes(i.aspectRatio)&&d.push({param:"aspect_ratio",message:`Aspect Ratio '${i.aspectRatio}' is not supported by ${a.name}. Supported: ${a.allowedAspectRatios.join(", ")}`,suggested:a.allowedAspectRatios[0]}),i.frameRate&&!a.allowedFrameRates.includes(String(i.frameRate))&&d.push({param:"frame_rate",message:`Frame Rate '${i.frameRate}' is not supported by ${a.name}. Supported: ${a.allowedFrameRates.join(", ")}`,suggested:a.allowedFrameRates[0]}),{valid:d.length===0,violations:d}}supports(t,i){const a=this.profiles[t];return a?!!a[i]:!0}validateContent(t){if(!t)return{safe:!0,flagged:[]};const a=["nsfw","naked","graphic violence","blood","hate speech"].filter(d=>t.toLowerCase().includes(d));return{safe:a.length===0,flagged:a}}formatPayload(t,i){var d;const a={target_model:((d=this.profiles[t])==null?void 0:d.name)||t,generated_at:new Date().toISOString(),...i};return t==="sora"?{model:"sora-1.0",prompts:i.scenes.map(v=>v.description),advanced_params:{...i.global_parameters},metadata:a}:a}}class Ut{constructor(){this.STORAGE_KEY="json_prompt_gen_global_params",this.modelService=new Dt,this.defaults={platform_preset:"veo",aspect_ratio:"16:9",resolution:"1080p",frame_rate:"24"},this.params=this.loadState()}loadState(){try{const t=localStorage.getItem(this.STORAGE_KEY);if(t)return{...this.defaults,...JSON.parse(t)}}catch(t){console.warn("Failed to load global params:",t)}return{...this.defaults}}saveState(){try{localStorage.setItem(this.STORAGE_KEY,JSON.stringify(this.params))}catch(t){console.warn("Failed to save global params:",t)}}getParams(){return{...this.params}}updateParam(t,i){if(this.params.hasOwnProperty(t)){this.params[t]=i;const a=this.params.platform_preset,d=this.modelService.validateParams(a,this.params);return d.valid||(d.violations.forEach(v=>{this.params[v.param]=v.suggested}),window.dispatchEvent(new CustomEvent("global-params-corrected",{detail:{violations:d.violations}}))),this.saveState(),!0}return!1}resetDefaults(){return this.params={...this.defaults},this.saveState(),this.params}}class Ft{constructor(){this.dbName="JsonPromptGenDB",this.storeName="templates",this.dbVersion=1,this.db=null,this.initPromise=this.initDB()}initDB(){return new Promise((t,i)=>{const a=indexedDB.open(this.dbName,this.dbVersion);a.onerror=d=>{console.error("TemplateService: Database error",d.target.error),i("Database error: "+d.target.error)},a.onsuccess=d=>{this.db=d.target.result,t(this.db)},a.onupgradeneeded=d=>{const v=d.target.result;if(!v.objectStoreNames.contains(this.storeName)){const h=v.createObjectStore(this.storeName,{keyPath:"id"});h.createIndex("name","name",{unique:!1}),h.createIndex("updatedAt","updatedAt",{unique:!1}),h.createIndex("tags","tags",{unique:!1,multiEntry:!0})}}})}async getDB(){return this.db||await this.initPromise,this.db}async saveTemplate(t){const i=await this.getDB();return new Promise((a,d)=>{const h=i.transaction([this.storeName],"readwrite").objectStore(this.storeName),g={id:t.id||crypto.randomUUID(),name:t.name||"Untitled Template",description:t.description||"",content:t.content||{},tags:t.tags||[],createdAt:t.createdAt||Date.now(),updatedAt:Date.now(),usageCount:t.usageCount||0},y=h.put(g);y.onsuccess=()=>{a(g)},y.onerror=b=>{d("Error saving template: "+b.target.error)}})}async getTemplate(t){const i=await this.getDB();return new Promise((a,d)=>{const g=i.transaction([this.storeName],"readonly").objectStore(this.storeName).get(t);g.onsuccess=()=>{a(g.result)},g.onerror=y=>{d("Error fetching template: "+y.target.error)}})}async getAllTemplates(){const t=await this.getDB();return new Promise((i,a)=>{const g=t.transaction([this.storeName],"readonly").objectStore(this.storeName).index("updatedAt").openCursor(null,"prev"),y=[];g.onsuccess=b=>{const L=b.target.result;L?(y.push(L.value),L.continue()):i(y)},g.onerror=b=>{a("Error fetching all templates: "+b.target.error)}})}async deleteTemplate(t){const i=await this.getDB();return new Promise((a,d)=>{const g=i.transaction([this.storeName],"readwrite").objectStore(this.storeName).delete(t);g.onsuccess=()=>{a(!0)},g.onerror=y=>{d("Error deleting template: "+y.target.error)}})}}class Jt{constructor(t){this.services=t,this.currentPromptData=null,this.saveModal=null,this.galleryModal=null,this.saveForm=null,this.galleryGrid=null,this.init()}init(){document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>this.setup()):this.setup()}setup(){this.injectModals(),this.saveModal=document.getElementById("template-save-modal"),this.galleryModal=document.getElementById("template-gallery-modal"),this.saveForm=document.getElementById("template-save-form"),this.galleryGrid=document.getElementById("template-gallery-grid"),this.bindEvents()}injectModals(){document.body.insertAdjacentHTML("beforeend",`
            <!-- Save Template Modal -->
            <div id="template-save-modal" class="template-modal-overlay">
                <div class="template-modal save-dialog">
                    <div class="template-modal-header">
                        <h3 class="gradient-text">Save Template</h3>
                        <button class="close-modal-btn" data-target="template-save-modal"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
                    </div>
                    <form id="template-save-form">
                        <div class="template-modal-body">
                            <div class="template-form-group">
                                <label for="template-name">Template Name</label>
                                <input type="text" id="template-name" class="template-form-input" placeholder="e.g., Cinematic Sci-Fi Setup" required>
                            </div>
                            <div class="template-form-group">
                                <label for="template-desc">Description (Optional)</label>
                                <textarea id="template-desc" class="template-form-textarea" placeholder="Briefly describe what this template does..."></textarea>
                            </div>
                            <div class="template-form-group">
                                <label for="template-tags">Tags (Comma separated)</label>
                                <input type="text" id="template-tags" class="template-form-input" placeholder="scifi, dark, 8k">
                            </div>
                        </div>
                        <div class="template-modal-footer">
                            <button type="button" class="btn-secondary close-modal-btn" data-target="template-save-modal">Cancel</button>
                            <button type="submit" class="btn-primary">Save Template</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Template Gallery Modal -->
            <div id="template-gallery-modal" class="template-modal-overlay">
                <div class="template-modal">
                    <div class="template-modal-header">
                        <h3 class="gradient-text">Template Gallery</h3>
                        <button class="close-modal-btn" data-target="template-gallery-modal"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
                    </div>
                    <div class="template-modal-body">
                        <div id="template-gallery-grid" class="template-grid">
                            <!-- Templates will be injected here -->
                        </div>
                    </div>
                </div>
            </div>
        `)}bindEvents(){document.addEventListener("click",t=>{if(t.target.closest(".close-modal-btn")){const i=t.target.closest(".close-modal-btn").dataset.target;this.closeModal(i)}t.target.classList.contains("template-modal-overlay")&&this.closeModal(t.target.id)}),this.saveForm.addEventListener("submit",async t=>{t.preventDefault(),await this.handleSaveSubmit()})}openSaveModal(t){this.currentPromptData=t,this.saveForm.reset(),this.saveModal.classList.add("active"),document.getElementById("template-name").focus()}async openGallery(){await this.renderGallery(),this.galleryModal.classList.add("active")}closeModal(t){document.getElementById(t).classList.remove("active")}async handleSaveSubmit(){const t=document.getElementById("template-name").value,i=document.getElementById("template-desc").value,d=document.getElementById("template-tags").value.split(",").map(h=>h.trim()).filter(h=>h),v={name:t,description:i,tags:d,content:this.currentPromptData};try{await this.services.saveTemplate(v),this.closeModal("template-save-modal"),window.showToast&&window.showToast("Template Saved",`"${t}" has been saved to your gallery.`,"success")}catch(h){console.error("Failed to save template:",h),window.showToast&&window.showToast("Error","Failed to save template.","error")}}async renderGallery(){this.galleryGrid.innerHTML='<div class="template-loading">Loading templates...</div>';try{const t=await this.services.getAllTemplates();if(this.galleryGrid.innerHTML="",t.length===0){this.galleryGrid.innerHTML=`
                    <div class="template-empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg>
                        <p>No templates found. Create your first template from the generator!</p>
                    </div>
                `;return}t.forEach(i=>{const a=this.createTemplateCard(i);this.galleryGrid.appendChild(a)})}catch(t){console.error("Error rendering gallery:",t),this.galleryGrid.innerHTML='<div class="template-error">Failed to load templates.</div>'}}createTemplateCard(t){const i=document.createElement("div");i.className="template-card",i.onclick=d=>{d.target.closest(".icon-btn")||this.applyTemplate(t)};const a=new Date(t.updatedAt).toLocaleDateString();return i.innerHTML=`
            <div class="template-card-header">
                <h4 class="template-name" title="${t.name}">${t.name}</h4>
                <div class="template-actions">
                    <button class="icon-btn delete" title="Delete" onclick="window.templateUI.deleteTemplate('${t.id}', event)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    </button>
                </div>
            </div>
            <p class="template-desc">${t.description||"No description"}</p>
            <div class="template-info">
                <span>${a}</span>
                <span class="template-tag">${t.tags[0]||"Template"}</span>
            </div>
        `,i}async deleteTemplate(t,i){if(i.stopPropagation(),confirm("Are you sure you want to delete this template?"))try{await this.services.deleteTemplate(t),this.renderGallery(),window.showToast&&window.showToast("Deleted","Template removed.","success")}catch(a){console.error("Delete failed:",a)}}applyTemplate(t){const i=new CustomEvent("apply-template",{detail:t.content});window.dispatchEvent(i),this.closeModal("template-gallery-modal"),window.showToast&&window.showToast("Template Applied",`"${t.name}" loaded successfully.`,"success")}}window.CryptoUtils=$t;window.AnalyticsService=ft;window.historyService=new bt;document.addEventListener("DOMContentLoaded",()=>{var lt,ct,ut,mt,pt,vt;try{new jt}catch(e){console.error("GettingStarted Init Error:",e)}const f=localStorage.getItem("pending_dict_term");if(f)try{const e=JSON.parse(f),o=document.querySelector(".scene-description");if(o){const n=o.value;n?o.value=`${n}, ${e.name}`:o.value=e.name,o.dispatchEvent(new Event("input",{bubbles:!0})),((r,l,c="info")=>{if(typeof showToast=="function")showToast(r,l,c);else if(window.showToast)window.showToast(r,l,c);else{let u=document.getElementById("toast-container");u||(u=document.createElement("div"),u.id="toast-container",u.className="toast-container",document.body.appendChild(u));const m=document.createElement("div");m.className=`toast toast-${c} show`,m.innerHTML=`
                            <div class="toast-header">
                                <strong class="me-auto">${r}</strong>
                                <button type="button" class="btn-close" onclick="this.parentElement.parentElement.remove()"></button>
                            </div>
                            <div class="toast-body">${l}</div>
                        `,u.appendChild(m),setTimeout(()=>{m.classList.remove("show"),setTimeout(()=>m.remove(),300)},3e3)}})("Term Applied",`Added "${e.name}" to your prompt.`,"success"),localStorage.removeItem("pending_dict_term")}}catch(e){console.error("Error applying dictionary term:",e),localStorage.removeItem("pending_dict_term")}try{const e=new Ft,o=new Jt(e);window.templateUI=o}catch(e){console.error("Template System Init Error:",e)}const t=new ft;window.gaTracker=t;const i=document.getElementById("scenes-container"),a=document.getElementById("add-scene-btn"),d=document.getElementById("generate-btn"),v=document.getElementById("output-json"),h=document.getElementById("sidebar"),g=document.getElementById("sidebar-overlay"),y=document.getElementById("hamburger-btn"),b=document.getElementById("sidebar-close"),L=document.querySelectorAll(".sidebar-link"),T=document.getElementById("sidebar-reset-btn"),_=document.getElementById("sidebar-export-btn");function V(){h.classList.add("active"),g.classList.add("active"),document.body.style.overflow="hidden",t.trackEvent("sidebar_open")}function x(){h.classList.remove("active"),g.classList.remove("active"),document.body.style.overflow=""}y.addEventListener("click",V),b.addEventListener("click",x),g.addEventListener("click",x),L.forEach(e=>{e.addEventListener("click",o=>{const n=e.dataset.section;n&&(o.preventDefault(),Ce(n),x())})}),T&&T.addEventListener("click",e=>{var o;e.preventDefault(),t.trackEvent("sidebar_action",{action:"reset"}),x(),(o=document.getElementById("reset-btn"))==null||o.click()}),_&&_.addEventListener("click",e=>{var o;e.preventDefault(),t.trackEvent("sidebar_action",{action:"export"}),x(),(o=document.getElementById("download-btn"))==null||o.click()}),document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&t.trackEvent("tab_wake_up")});const Ee=new Ht(t),j=new bt,me=document.getElementById("feedback-modal"),Oe=document.getElementById("sidebar-feedback-btn"),Me=document.getElementById("feedback-close-btn"),Re=document.getElementById("feedback-cancel-btn"),pe=document.getElementById("feedback-submit-btn"),$e=document.querySelectorAll("#feedback-type-chips .chip");let ke="bug";function Ge(){me&&(me.classList.remove("hidden"),t.trackEvent("feedback_open"),x())}function Le(){me&&me.classList.add("hidden")}const He=document.getElementById("footer-feedback-btn");Oe&&Oe.addEventListener("click",Ge),He&&He.addEventListener("click",Ge),Me&&Me.addEventListener("click",Le),Re&&Re.addEventListener("click",Le),$e.forEach(e=>{e.addEventListener("click",()=>{$e.forEach(o=>o.classList.remove("active")),e.classList.add("active"),ke=e.dataset.value})}),pe&&pe.addEventListener("click",async()=>{const e=document.getElementById("feedback-message").value;if(!e.trim()){showToast("Error","Please enter a message.","error");return}pe.classList.add("loading");try{await Ee.submitFeedback(ke,e),showToast("Feedback Sent","Thank you for your feedback!","success"),t.trackEvent("submit_feedback",{type:ke}),document.getElementById("feedback-message").value="",Le()}catch{showToast("Error","Failed to send feedback.","error")}finally{pe.classList.remove("loading")}});let k;try{k=new Ut}catch(e){console.error("GlobalParamsService Init Error:",e),k={getParams:()=>({platform_preset:"veo",aspect_ratio:"16:9",resolution:"1080p",frame_rate:"24"}),updateParam:()=>!1,resetDefaults:()=>({}),modelService:{validateContent:()=>({safe:!0}),validateParams:()=>({valid:!0})}}}const D=[{key:"aspect_ratio",wrapperId:"global-aspect-ratio-dropdown",inputId:"global-aspect-ratio",displayId:"global-aspect-ratio-display"},{key:"resolution",wrapperId:"global-resolution-dropdown",inputId:"global-resolution",displayId:"global-resolution-display"},{key:"frame_rate",wrapperId:"global-frame-rate-dropdown",inputId:"global-frame-rate",displayId:"global-frame-rate-display"},{key:"platform_preset",wrapperId:"global-platform-dropdown",inputId:"global-platform",displayId:"global-platform-display"}];D.forEach(e=>{const o=document.getElementById(e.wrapperId);if(!o)return;const n=o.querySelector(".dropdown-trigger"),s=o.querySelector(".dropdown-menu"),r=document.getElementById(e.inputId),l=document.getElementById(e.displayId);n.addEventListener("click",c=>{c.stopPropagation(),D.forEach(u=>{var m;u.wrapperId!==e.wrapperId&&((m=document.getElementById(u.wrapperId))==null||m.classList.remove("open"))}),o.classList.toggle("open")}),s.addEventListener("click",c=>{c.stopPropagation();const u=c.target.closest(".dropdown-item");if(u){const m=u.dataset.value,p=u.textContent;l.textContent=p,s.querySelectorAll(".dropdown-item").forEach(w=>w.classList.remove("selected")),u.classList.add("selected"),r.value=m,k.updateParam(e.key,m),t.trackEvent("parameter_change",{param:e.key,value:m}),ve(),Te(),o.classList.remove("open")}})}),document.addEventListener("click",()=>{D.forEach(e=>{var o;(o=document.getElementById(e.wrapperId))==null||o.classList.remove("open")})});function oe(){const e=k.getParams(),o=(n,s)=>{const r=document.getElementById(n.wrapperId),l=document.getElementById(n.inputId),c=document.getElementById(n.displayId);if(r&&l&&c){l.value=s;const u=r.querySelector(`.dropdown-item[data-value="${s}"]`);u&&(c.textContent=u.textContent,r.querySelectorAll(".dropdown-item").forEach(m=>m.classList.remove("selected")),u.classList.add("selected"))}};o(D[0],e.aspect_ratio),o(D[1],e.resolution),o(D[2],e.frame_rate),o(D[3],e.platform_preset),ve()}function ve(){const o=k.getParams().platform_preset,n=k.modelService,s=n.supports(o,"supportsNegativePrompt");document.querySelectorAll(".scene-negative-prompt").forEach(l=>{const c=l.closest(".form-group");if(c){const u=c.previousElementSibling;s?(c.classList.remove("hidden"),u&&u.classList.remove("no-separator")):(c.classList.add("hidden"),u&&u.classList.add("no-separator"))}});const r=n.supports(o,"supportsCameraControls");document.querySelectorAll(".scene-camera-input").forEach(l=>{const c=l.closest(".form-group");c&&(r?(c.classList.remove("disabled-group"),l.disabled=!1,c.style.opacity="1",c.style.pointerEvents="auto"):(c.classList.add("disabled-group"),l.disabled=!0,c.style.opacity="0.5",c.style.pointerEvents="none"))})}window.addEventListener("global-params-corrected",e=>{const o=e.detail.violations,n=o.map(s=>`• ${s.message}`).join("<br>");showToast("Settings Adjusted",n,"warning",6e3),t.trackEvent("settings_auto_adjusted",{violation_count:o.length}),oe(),ve()}),oe();const je=document.getElementById("reset-global-params");je&&je.addEventListener("click",()=>{confirm("Reset all global parameters to defaults?")&&(k.resetDefaults(),oe(),showToast("Global Parameters Reset","All global settings have been restored to defaults.","info"))});let Y=1;a.addEventListener("click",()=>{Y++;const e=Y;t.trackEvent("add_scene",{scene_id:e});const o=`
            <div class="scene-item" data-scene-id="${e}">
                <div class="scene-header">
                    <h4 class="scene-title" style="margin: 0; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px;">Scene ${e}</h4>
                    <div class="scene-actions">
                        <button class="scene-undo-btn hidden" title="Undo AI Enhancement">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 10h10a5 5 0 0 1 5 5v2"/><path d="m3 10 6 6"/><path d="m3 10 6-6"/></svg>
                        </button>
                        <button class="scene-redo-btn hidden" title="Redo AI Enhancement">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10H11a5 5 0 0 0-5 5v2"/><path d="m21 10-6 6"/><path d="m21 10-6-6"/></svg>
                        </button>
                        <button class="scene-enhance-btn" title="Enhance with AI">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" class="enhance-stars-icon">
                                <path d="M15.5 5.5 L16.8 10.2 L21.5 11.5 L16.8 12.8 L15.5 17.5 L14.2 12.8 L9.5 11.5 L14.2 10.2 Z" />
                                <path d="M5.5 2.5 L6.2 4.8 L8.5 5.5 L6.2 6.2 L5.5 8.5 L4.8 6.2 L2.5 5.5 L4.8 4.8 Z" />
                                <path d="M6.5 15.5 L7.2 17.8 L9.5 18.5 L7.2 19.2 L6.5 21.5 L5.8 19.2 L3.5 18.5 L5.8 17.8 Z" />
                            </svg>
                        </button>
                        <button class="remove-scene-btn" onclick="removeScene(this)" title="Remove Scene">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="section-label">Scene Description</label>
                    <textarea class="scene-description" placeholder="Describe your scene in detail..." style="min-height: 100px;"></textarea>
                </div>
                <div class="scene-params-grid">
                <div class="form-group">
                    <label class="section-label">Camera Angle</label>
                    <div class="input-with-dropdown">
                        <input type="text" class="scene-camera-input" 
                            placeholder="Select angle or type custom..."
                            aria-label="Camera Angle">
                        <div class="input-dropdown-wrapper">
                            <button type="button" class="input-dropdown-trigger" aria-label="Open camera presets">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </button>
                            <div class="input-dropdown-menu">
                                <div class="dropdown-item" data-value="pan_left">Pan Left</div>
                                <div class="dropdown-item" data-value="pan_right">Pan Right</div>
                                <div class="dropdown-item" data-value="zoom_in">Zoom In</div>
                                <div class="dropdown-item" data-value="zoom_out">Zoom Out</div>
                                <div class="dropdown-item" data-value="dolly_zoom">Dolly Zoom</div>
                                <div class="dropdown-item" data-value="tracking_shot">Track</div>
                                <div class="dropdown-item" data-value="eye_level">Eye Level</div>
                                <div class="dropdown-item" data-value="low_angle">Low Angle</div>
                                <div class="dropdown-item" data-value="high_angle">High Angle</div>
                                <div class="dropdown-item" data-value="aerial_view">Aerial View</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="section-label">Lighting Style</label>
                    <div class="input-with-dropdown">
                        <input type="text" class="scene-lighting-input" 
                            placeholder="Select lighting or type custom..."
                            aria-label="Lighting Style">
                        <div class="input-dropdown-wrapper">
                            <button type="button" class="input-dropdown-trigger" aria-label="Open lighting presets">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </button>
                            <div class="input-dropdown-menu">
                                <div class="dropdown-item" data-value="natural">Natural</div>
                                <div class="dropdown-item" data-value="golden_hour">Golden Hour</div>
                                <div class="dropdown-item" data-value="blue_hour">Blue Hour</div>
                                <div class="dropdown-item" data-value="neon">Neon Cyberpunk</div>
                                <div class="dropdown-item" data-value="studio">Studio</div>
                                <div class="dropdown-item" data-value="dramatic">Dramatic</div>
                                <div class="dropdown-item" data-value="cinematic">Cinematic</div>
                                <div class="dropdown-item" data-value="softbox">Softbox</div>
                                <div class="dropdown-item" data-value="backlit">Backlit</div>
                                <div class="dropdown-item" data-value="rim_light">Rim Light</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="section-label">Color Palettes</label>
                    <div class="input-with-dropdown">
                        <input type="text" class="scene-color-input" placeholder="Select palette or type custom..." aria-label="Color Palette">
                        <div class="input-dropdown-wrapper">
                            <button type="button" class="input-dropdown-trigger" aria-label="Open color presets">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                            </button>
                            <div class="input-dropdown-menu">
                                <div class="dropdown-item" data-value="monochromatic">Monochromatic</div>
                                <div class="dropdown-item" data-value="complementary">Complementary</div>
                                <div class="dropdown-item" data-value="analogous">Analogous</div>
                                <div class="dropdown-item" data-value="teal_orange">Cinematic Teal & Orange</div>
                                <div class="dropdown-item" data-value="cyberpunk">Cyberpunk Glow</div>
                                <div class="dropdown-item" data-value="sepia">Sepia Tone</div>
                                <div class="dropdown-item" data-value="vibrant">High Saturation</div>
                                <div class="dropdown-item" data-value="desaturated">Moody Desaturated</div>
                                <div class="dropdown-item" data-value="pastel">Pastel Tones</div>
                                <div class="dropdown-item" data-value="bw">Classic B&W</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="section-label">Mood Descriptors</label>
                    <div class="input-with-dropdown">
                        <input type="text" class="scene-mood-input" placeholder="Select mood or type custom..." aria-label="Mood Descriptors">
                        <div class="input-dropdown-wrapper">
                            <button type="button" class="input-dropdown-trigger" aria-label="Open mood presets">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                            </button>
                            <div class="input-dropdown-menu">
                                <div class="dropdown-item" data-value="ethereal">Ethereal/Dreamy</div>
                                <div class="dropdown-item" data-value="ominous">Dark/Ominous</div>
                                <div class="dropdown-item" data-value="energetic">High Energy</div>
                                <div class="dropdown-item" data-value="calm">Calm/Peaceful</div>
                                <div class="dropdown-item" data-value="nostalgic">Nostalgic</div>
                                <div class="dropdown-item" data-value="cyberpunk">Cyberpunk/Neon</div>
                                <div class="dropdown-item" data-value="epic">Epic/Cinematic</div>
                                <div class="dropdown-item" data-value="suspenseful">Suspenseful</div>
                                <div class="dropdown-item" data-value="melancholic">Melancholic</div>
                                <div class="dropdown-item" data-value="whimsical">Whimsical</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="section-label">Sound Design</label>
                    <div class="input-with-dropdown">
                        <input type="text" class="scene-sound-input" placeholder="Describe sound or select presets..." aria-label="Sound Design">
                        <div class="input-dropdown-wrapper">
                            <button type="button" class="input-dropdown-trigger" aria-label="Open sound presets">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                            </button>
                            <div class="input-dropdown-menu">
                                <div class="dropdown-item" data-value="ambient_wind">Ambient Wind</div>
                                <div class="dropdown-item" data-value="orchestral">Cinematic Orchestral</div>
                                <div class="dropdown-item" data-value="low_hum">Low Hum</div>
                                <div class="dropdown-item" data-value="nature">Nature Sounds</div>
                                <div class="dropdown-item" data-value="urban_traffic">Urban Traffic</div>
                                <div class="dropdown-item" data-value="synthwave">80s Synth</div>
                                <div class="dropdown-item" data-value="industrial">Heavy Industrial</div>
                                <div class="dropdown-item" data-value="silence">Deep Silence</div>
                                <div class="dropdown-item" data-value="asmr">ASMR Rustle</div>
                                <div class="dropdown-item" data-value="glitch">Glitchy Beats</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="section-label">Negative Prompts</label>
                    <div class="input-with-dropdown">
                        <input type="text" class="scene-negative-prompt" 
                            placeholder="Type elements to exclude or select from presets..."
                            aria-label="Custom negative prompts">
                        <div class="input-dropdown-wrapper">
                            <button type="button" class="input-dropdown-trigger" aria-label="Open presets">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </button>
                            <div class="input-dropdown-menu">
                                <div class="dropdown-item" data-value="blurry">Blurry</div>
                                <div class="dropdown-item" data-value="low_res">Low Res</div>
                                <div class="dropdown-item" data-value="deformed">Deformed</div>
                                <div class="dropdown-item" data-value="watermark">Watermark</div>
                                <div class="dropdown-item" data-value="flicker">Flicker</div>
                                <div class="dropdown-item" data-value="grainy">Grainy</div>
                                <div class="dropdown-item" data-value="overexposed">Overexposed</div>
                                <div class="dropdown-item" data-value="extra_limbs">Extra Limbs</div>
                                <div class="dropdown-item" data-value="distorted">Distorted</div>
                                <div class="dropdown-item" data-value="unrealistic">Unrealistic</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="section-label">Composition Principles</label>
                    <div class="input-with-dropdown">
                        <input type="text" class="scene-composition-input"
                            placeholder="Select composition or type custom..."
                            aria-label="Composition Principles">
                        <div class="input-dropdown-wrapper">
                            <button type="button" class="input-dropdown-trigger"
                                aria-label="Open composition presets">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                    viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </button>
                            <div class="input-dropdown-menu">
                                <div class="dropdown-item" data-value="rule_of_thirds">Rule of Thirds</div>
                                <div class="dropdown-item" data-value="center_framed">Center Framed</div>
                                <div class="dropdown-item" data-value="leading_lines">Leading Lines</div>
                                <div class="dropdown-item" data-value="golden_ratio">Golden Ratio</div>
                                <div class="dropdown-item" data-value="negative_space">Negative Space</div>
                                <div class="dropdown-item" data-value="symmetrical">Symmetrical</div>
                                <div class="dropdown-item" data-value="asymmetrical">Asymmetrical</div>
                                <div class="dropdown-item" data-value="depth_of_field">Depth of Field</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="section-label">Lens Techniques</label>
                    <div class="input-with-dropdown">
                        <input type="text" class="scene-lens-input"
                            placeholder="Select lens or type custom..." aria-label="Lens Techniques">
                        <div class="input-dropdown-wrapper">
                            <button type="button" class="input-dropdown-trigger"
                                aria-label="Open lens presets">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                    viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </button>
                            <div class="input-dropdown-menu">
                                <div class="dropdown-item" data-value="macro">Macro</div>
                                <div class="dropdown-item" data-value="wide_angle">Wide Angle</div>
                                <div class="dropdown-item" data-value="telephoto">Telephoto</div>
                                <div class="dropdown-item" data-value="fisheye">Fisheye</div>
                                <div class="dropdown-item" data-value="bokeh">Bokeh</div>
                                <div class="dropdown-item" data-value="tilt_shift">Tilt Shift</div>
                                <div class="dropdown-item" data-value="anamorphic">Anamorphic</div>
                                <div class="dropdown-item" data-value="prime_lens">Prime Lens</div>
                                <div class="dropdown-item" data-value="zoom_lens">Zoom Lens</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="section-label">Production Design</label>
                    <div class="input-with-dropdown">
                        <input type="text" class="scene-production-input"
                            placeholder="Select style or type custom..." aria-label="Production Design">
                        <div class="input-dropdown-wrapper">
                            <button type="button" class="input-dropdown-trigger"
                                aria-label="Open production presets">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                    viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </button>
                            <div class="input-dropdown-menu">
                                <div class="dropdown-item" data-value="minimalist">Minimalist</div>
                                <div class="dropdown-item" data-value="brutalist">Brutalist</div>
                                <div class="dropdown-item" data-value="futuristic">Futuristic</div>
                                <div class="dropdown-item" data-value="retro_vintage">Retro/Vintage</div>
                                <div class="dropdown-item" data-value="industrial">Industrial</div>
                                <div class="dropdown-item" data-value="gothic">Gothic</div>
                                <div class="dropdown-item" data-value="art_deco">Art Deco</div>
                                <div class="dropdown-item" data-value="cyberpunk">Cyberpunk</div>
                                <div class="dropdown-item" data-value="steampunk">Steampunk</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="section-label">Editing Techniques</label>
                    <div class="input-with-dropdown">
                        <input type="text" class="scene-editing-input"
                            placeholder="Select technique or type custom..."
                            aria-label="Editing Techniques">
                        <div class="input-dropdown-wrapper">
                            <button type="button" class="input-dropdown-trigger"
                                aria-label="Open editing presets">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                    viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </button>
                            <div class="input-dropdown-menu">
                                <div class="dropdown-item" data-value="fast_cut">Fast Cut</div>
                                <div class="dropdown-item" data-value="slow_motion">Slow Motion</div>
                                <div class="dropdown-item" data-value="jump_cut">Jump Cut</div>
                                <div class="dropdown-item" data-value="cross_dissolve">Cross Dissolve</div>
                                <div class="dropdown-item" data-value="match_cut">Match Cut</div>
                                <div class="dropdown-item" data-value="fade_to_black">Fade to Black</div>
                                <div class="dropdown-item" data-value="long_take">Long Take</div>
                                <div class="dropdown-item" data-value="montage">Montage</div>
                                <div class="dropdown-item" data-value="time_lapse">Time Lapse</div>
                            </div>
                        </div>
                    </div>
                </div>
                </div> <!-- End scene-params-grid -->
            </div>
        `;i.insertAdjacentHTML("beforeend",o),ve()}),i.addEventListener("click",e=>{const o=e.target.closest(".input-dropdown-trigger");if(o){e.stopPropagation();const s=o.closest(".input-dropdown-wrapper");document.querySelectorAll(".input-dropdown-wrapper.open").forEach(r=>{r!==s&&r.classList.remove("open")}),s.classList.toggle("open")}const n=e.target.closest(".input-dropdown-menu .dropdown-item");if(n){e.stopPropagation();const s=n.closest(".input-dropdown-wrapper"),r=s.closest(".input-with-dropdown").querySelector("input"),l=n.textContent.trim();let c=r.value.trim();c?c.split(",").map(m=>m.trim().toLowerCase()).includes(l.toLowerCase())||(r.value=`${c}, ${l}`):r.value=l,s.classList.remove("open"),r.focus(),r.dispatchEvent(new Event("input",{bubbles:!0}))}}),document.addEventListener("click",()=>{document.querySelectorAll(".input-dropdown-wrapper.open").forEach(e=>{e.classList.remove("open")})}),window.removeScene=function(e){const o=e.closest(".scene-item");o&&(o.remove(),St())};function St(){const e=i.querySelectorAll(".scene-item");e.forEach((o,n)=>{const s=o.querySelector("h4");s&&(s.textContent=`Scene ${n+1}`)}),Y=e.length}const De=document.getElementById("reset-btn");De&&De.addEventListener("click",()=>{var e,o;if(confirm("Are you sure you want to reset the generator? All current work will be lost.")){t.trackEvent("reset_generator");const n=i.querySelector('.scene-item[data-scene-id="1"]');n&&(n.querySelector(".scene-description").value="",n.querySelector(".scene-negative-prompt").value="",n.querySelector(".scene-camera-input").value="",n.querySelector(".scene-lighting-input").value="",n.querySelector(".scene-color-input").value="",n.querySelector(".scene-mood-input").value="",n.querySelector(".scene-sound-input").value="",n.querySelector(".scene-composition-input").value="",n.querySelector(".scene-lens-input").value="",n.querySelector(".scene-production-input").value="",n.querySelector(".scene-editing-input").value="",(e=n.querySelector(".scene-undo-btn"))==null||e.classList.add("hidden"),(o=n.querySelector(".scene-redo-btn"))==null||o.classList.add("hidden")),i.querySelectorAll('.scene-item:not([data-scene-id="1"])').forEach(r=>r.remove()),Y=1,v.value=JSON.stringify({platform:"veo",prompt:"Waiting for input...",parameters:{aspect_ratio:"16:9",resolution:"1080p"}},null,2),localStorage.removeItem(Ie),showToast("Generator Reset","All scenes and outputs have been cleared.","info")}});const Ie="json_prompt_gen_autosave";function Te(){const e=[];i.querySelectorAll(".scene-item").forEach(s=>{var r,l,c,u,m,p,w,S,C,O;e.push({description:s.querySelector(".scene-description").value,camera:((r=s.querySelector(".scene-camera-input"))==null?void 0:r.value)||"",lighting:((l=s.querySelector(".scene-lighting-input"))==null?void 0:l.value)||"",color:((c=s.querySelector(".scene-color-input"))==null?void 0:c.value)||"",mood:((u=s.querySelector(".scene-mood-input"))==null?void 0:u.value)||"",sound:((m=s.querySelector(".scene-sound-input"))==null?void 0:m.value)||"",negative:((p=s.querySelector(".scene-negative-prompt"))==null?void 0:p.value)||"",composition:((w=s.querySelector(".scene-composition-input"))==null?void 0:w.value)||"",lens:((S=s.querySelector(".scene-lens-input"))==null?void 0:S.value)||"",production:((C=s.querySelector(".scene-production-input"))==null?void 0:C.value)||"",editing:((O=s.querySelector(".scene-editing-input"))==null?void 0:O.value)||""})});const n={scenes:e,globalParams:k.getParams(),timestamp:Date.now()};localStorage.setItem(Ie,JSON.stringify(n))}function Et(){const e=localStorage.getItem(Ie);if(e)try{const o=JSON.parse(e);o.globalParams&&(Object.keys(o.globalParams).forEach(n=>{k.updateParam(n,o.globalParams[n])}),oe()),o.scenes&&o.scenes.length>0&&(i.innerHTML="",Y=0,o.scenes.forEach(n=>{a.click();const s=i.lastElementChild;s.querySelector(".scene-description").value=n.description||"",n.camera&&(s.querySelector(".scene-camera-input").value=n.camera),n.lighting&&(s.querySelector(".scene-lighting-input").value=n.lighting),n.color&&(s.querySelector(".scene-color-input").value=n.color),n.mood&&(s.querySelector(".scene-mood-input").value=n.mood),n.sound&&(s.querySelector(".scene-sound-input").value=n.sound),n.negative&&(s.querySelector(".scene-negative-prompt").value=n.negative),n.composition&&(s.querySelector(".scene-composition-input").value=n.composition),n.lens&&(s.querySelector(".scene-lens-input").value=n.lens),n.production&&(s.querySelector(".scene-production-input").value=n.production),n.editing&&(s.querySelector(".scene-editing-input").value=n.editing)}),showToast("Work Restored","Your previous session has been restored.","success"))}catch(o){console.error("Failed to restore work:",o)}}i.addEventListener("input",()=>{Te()}),Et(),d.addEventListener("click",async()=>{Te(),d.classList.add("loading"),await new Promise(e=>setTimeout(e,600));try{const e=[];if(i.querySelectorAll(".scene-item").forEach(u=>{var gt,ht,yt,wt;const m=u.querySelector(".scene-description").value,p=u.querySelector(".scene-camera-input").value.trim(),w=u.querySelector(".scene-lighting-input").value.trim(),S=u.querySelector(".scene-color-input").value.trim(),C=u.querySelector(".scene-mood-input").value.trim(),O=u.querySelector(".scene-sound-input").value.trim(),te=((gt=u.querySelector(".scene-composition-input"))==null?void 0:gt.value.trim())||"",H=((ht=u.querySelector(".scene-lens-input"))==null?void 0:ht.value.trim())||"",Se=((yt=u.querySelector(".scene-production-input"))==null?void 0:yt.value.trim())||"",Nt=((wt=u.querySelector(".scene-editing-input"))==null?void 0:wt.value.trim())||"",Ot=u.querySelector(".scene-negative-prompt").value.trim();m.trim()&&e.push({description:m.trim(),negative_prompt:Ot||null,parameters:{camera:p||null,lighting:w||null,color_palette:S||null,mood:C||null,sound_design:O||null,composition:te||null,lens_technique:H||null,production_design:Se||null,editing_technique:Nt||null}})}),e.length===0){showToast("Empty Prompt","Please add at least one scene description.","warning");return}const n=k.modelService.validateContent(JSON.stringify(e));if(!n.safe){showToast("Safety Violation",`Content contains prohibited terms: ${n.flagged.join(", ")}`,"error");return}const s=document.querySelector('input[name="gen-mode"]:checked'),r=s?s.value:"json",l=k.getParams(),c={platform:l.platform_preset,version:"1.0",scenes:[],global_parameters:{aspect_ratio:l.aspect_ratio,resolution:l.resolution,frame_rate:l.frame_rate}};if(r==="ai"){const u=I.getConfiguredProviders();if(u.length===0){showToast("Configuration Required","Please configure an AI provider in the integration hub first.","warning");return}const m=u[0];d.disabled=!0;try{const p=await I.generateFullJson(m,e);let w;try{w=JSON.parse(p)}catch{throw new Error("Failed to parse AI response as valid JSON.")}c.scenes=w;const S=k.modelService.formatPayload(l.platform_preset,c);v.value=JSON.stringify(S,null,2),j&&j.save(S,"ai"),t.trackGeneration(e.length,"ai",l.platform_preset),showToast("AI Generation Complete","Enhanced JSON prompt generated successfully!","success"),document.getElementById("output-section").classList.remove("hidden"),document.getElementById("output-section").scrollIntoView({behavior:"smooth",block:"start"})}catch(p){console.error("AI Gen Error:",p),showToast("Generation Failed",p.message,"error")}finally{d.disabled=!1}}else{c.scenes=e;const u=k.modelService.formatPayload(l.platform_preset,c);v.value=JSON.stringify(u,null,2),j&&j.save(u,"json"),t.trackGeneration(e.length,"json",l.platform_preset),showToast("Success","JSON generated successfully!","success"),document.getElementById("output-section").classList.remove("hidden"),document.getElementById("output-section").scrollIntoView({behavior:"smooth",block:"start"})}}catch(e){console.error("Generation Error:",e),showToast("Error","An unexpected error occurred.","error")}finally{d.classList.remove("loading")}}),document.getElementById("copy-btn").addEventListener("click",()=>{const e=v.value;if(!e||e.includes("Waiting for input...")){showToast("No Content","Generate a prompt first.","warning");return}navigator.clipboard.writeText(e).then(()=>{showToast("Copied","JSON prompt copied to clipboard!","success"),t.trackEvent("copy_json")}).catch(o=>{showToast("Error","Failed to copy to clipboard.","error")})}),document.getElementById("download-btn").addEventListener("click",()=>{const e=v.value;if(!e||e.includes("Waiting for input...")){showToast("No Content","Generate a prompt first.","warning");return}const o=new Blob([e],{type:"application/json"}),n=URL.createObjectURL(o),s=document.createElement("a");s.href=n,s.download=`veo-prompt-${Date.now()}.json`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(n),showToast("Downloaded","JSON file downloaded successfully.","success"),t.trackEvent("download_json")});const E=new Mt;document.getElementById("dictionary-section");const kt=document.getElementById("generator-section");document.getElementById("output-section");const z=document.querySelectorAll(".main-nav a"),q=document.getElementById("dict-content"),A=document.getElementById("dict-category-list"),Ue=document.getElementById("dict-search"),ne=document.getElementById("dict-active-category-title"),W=document.getElementById("dict-sidebar"),M=document.getElementById("dict-sidebar-overlay"),Fe=document.getElementById("dict-hamburger-btn"),Je=document.getElementById("dict-sidebar-close");function Lt(){W==null||W.classList.add("active"),M==null||M.classList.add("active")}function xe(){W==null||W.classList.remove("active"),M==null||M.classList.remove("active")}Fe&&Fe.addEventListener("click",Lt),Je&&Je.addEventListener("click",xe),M&&M.addEventListener("click",xe);const I=new Gt,It=document.getElementById("llm-section"),Ke=document.getElementById("ai-enhance-btn"),ge=document.getElementById("llm-key-modal"),Ve=document.getElementById("llm-modal-close-btn"),Ye=document.getElementById("key-modal-cancel"),ze=document.getElementById("key-modal-save"),Be=document.getElementById("provider-api-key"),U=document.getElementById("key-validation-status"),We=document.querySelectorAll(".provider-card"),Z=document.querySelector(".usage-dashboard");let se=null,F=null;I.init().then(()=>{qe()});const X=document.getElementById("contribution-modal"),Ze=document.getElementById("dict-contribute-btn"),Xe=document.getElementById("modal-close-btn"),Qe=document.getElementById("modal-cancel-btn"),he=document.getElementById("modal-submit-btn");document.getElementById("contrib-category"),document.getElementById("new-category-check");const J=document.getElementById("new-category-name"),Q=document.getElementById("contrib-difficulty-pills");let P=null;const ye=document.getElementById("toggle-api-key");ye&&ye.addEventListener("click",()=>{const e=document.getElementById("provider-api-key"),o=ye.querySelector(".eye-icon"),n=ye.querySelector(".eye-off-icon");e.type==="password"?(e.type="text",o.classList.add("hidden"),n.classList.remove("hidden")):(e.type="password",o.classList.remove("hidden"),n.classList.add("hidden"))});function Ce(e){var r,l;if(!e)return;t.trackEvent("section_view",{section:e}),document.querySelectorAll(".main-nav a").forEach(c=>{c.dataset.section===e?c.classList.add("active"):c.classList.remove("active")}),document.querySelectorAll(".sidebar-link").forEach(c=>{c.dataset.section===e?c.classList.add("active"):c.classList.remove("active")}),document.querySelectorAll("section").forEach(c=>c.classList.add("hidden"));const o=document.querySelector(".hero-section"),n=document.querySelector(".dict-hero");o==null||o.classList.add("hidden"),n==null||n.classList.add("hidden");const s=document.getElementById(e);s&&s.classList.remove("hidden"),e==="generator-section"?(o==null||o.classList.remove("hidden"),(r=document.getElementById("global-params-section"))==null||r.classList.remove("hidden"),(l=document.getElementById("output-section"))==null||l.classList.remove("hidden")):e==="dictionary-section"?(n==null||n.classList.remove("hidden"),E.isInitialized||E.init().then(()=>{_e(),Ae(),setTimeout(()=>{const c=A==null?void 0:A.querySelector("li");c&&c.querySelector(".category-name").click()},100)})):e==="llm-section"?qe():e==="history-section"&&typeof G=="function"&&G("section")}window.switchSection=Ce,z.forEach(e=>{e.addEventListener("click",o=>{o.preventDefault();const n=e.dataset.section;Ce(n)})});function _e(){if(!A)return;A.innerHTML="",E.getAllCategories().forEach(o=>{const n=document.createElement("li"),s=E.isCategoryUserCreated(o.id);s&&n.classList.add("user-category");const r=document.createElement("span");if(r.textContent=o.name,r.className="category-name",n.appendChild(r),s){const l=document.createElement("button");l.className="category-delete-btn",l.title="Delete Category",l.innerHTML=`
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                `,l.addEventListener("click",c=>{c.stopPropagation(),_t(o.id)}),n.appendChild(l)}n.dataset.catId=o.id,r.addEventListener("click",()=>{A.querySelectorAll("li").forEach(l=>l.classList.remove("active")),n.classList.add("active"),P=o.id,ne.textContent=o.name,ie(o.id),xe()}),A.appendChild(n)})}function ie(e){if(q.innerHTML="",!e){q.innerHTML='<div class="empty-state">Select a category from the sidebar to view terms</div>';return}E.getTermsByCategory(e).forEach(n=>{const s=et(n);q.appendChild(s)})}function et(e){const o=document.createElement("div"),n=E.isUserCreated(e.id);o.className=`term-card ${n?"user-term":""}`,o.dataset.termId=e.id;const s=e.examples&&e.examples.length>0?`<div class="term-examples">
                <h5>Examples:</h5>
                <ul>${e.examples.map(w=>`<li>${w}</li>`).join("")}</ul>
               </div>`:"",r=e.difficulty||"beginner",l=e.author||"System",c=e.likes||0,u=n?`
            <button class="term-manage-btn edit-btn" data-term-id="${e.id}" title="Edit Term">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
            </button>
            <button class="term-manage-btn delete-btn" data-term-id="${e.id}" title="Delete Term">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
            </button>
        `:"";o.innerHTML=`
            <div class="term-header">
                <h4 class="term-title">${e.name}</h4>
                <div class="term-header-right">
                    <span class="difficulty-badge ${r}">${r}</span>
                    ${u}
                </div>
            </div>
            <p class="term-definition">${e.definition}</p>
            ${s}
            <div class="term-footer">
                <div class="term-author">By: <span>@${l}</span></div>
                <div class="term-actions">
                    <button class="term-action-btn like-btn" data-term-id="${e.id}">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                        <span class="like-count">${c}</span>
                    </button>
                    <button class="btn-use-prompt" data-term-name="${e.name}">Use in Prompt</button>
                </div>
            </div>
        `;const m=o.querySelector(".like-btn");return m.addEventListener("click",()=>Tt(e.id,m)),o.querySelector(".btn-use-prompt").addEventListener("click",()=>xt(e.name)),n&&(o.querySelector(".edit-btn").addEventListener("click",()=>Bt(e.id)),o.querySelector(".delete-btn").addEventListener("click",()=>Ct(e.id))),o}function Tt(e,o){o.classList.toggle("liked");const n=o.querySelector(".like-count");t.trackEvent("dict_like_term",{term_id:e,liked:o.classList.contains("liked")});let s=parseInt(n.textContent)||0;o.classList.contains("liked")?s++:s=Math.max(0,s-1),n.textContent=s;const r=JSON.parse(localStorage.getItem("likedTerms")||"[]");if(o.classList.contains("liked"))r.includes(e)||r.push(e);else{const l=r.indexOf(e);l>-1&&r.splice(l,1)}localStorage.setItem("likedTerms",JSON.stringify(r))}function xt(e){var n,s,r;const o=document.querySelector(".scene-description");if(o){const l=o.value;o.value=l?`${l}, ${e}`:e,t.trackEvent("dict_use_term",{term_name:e}),o.dispatchEvent(new Event("input",{bubbles:!0}));const c=Array.from(z).find(u=>u.textContent.trim()==="JSON Generator");c?c.click():(document.querySelectorAll("section").forEach(u=>u.classList.add("hidden")),kt.classList.remove("hidden"),(n=document.getElementById("global-params-section"))==null||n.classList.remove("hidden"),(s=document.getElementById("output-section"))==null||s.classList.remove("hidden"),(r=document.querySelector(".hero-section"))==null||r.classList.remove("hidden"),z.forEach(u=>u.classList.remove("active")),z[0]&&z[0].classList.add("active")),typeof showToast=="function"&&showToast("Term Applied",`"${e}" added to scene 1`,"success")}else{const l=Array.from(z).find(c=>c.textContent.trim()==="JSON Generator");l&&l.click(),typeof showToast=="function"&&showToast("No Active Scene","Add a scene first to use dictionary terms.","warning")}}let we=null,ee=null;function Bt(e){const o=E.getTermById(e);if(!o)return;const{term:n,categoryId:s}=o;we=e,ee=s,document.getElementById("contrib-username").value=n.author||"",document.getElementById("contrib-term-name").value=n.name||"",document.getElementById("contrib-definition").value=n.definition||"",document.getElementById("contrib-examples").value=n.examples?n.examples.join(", "):"",R=s;const r=E.getAllCategories().find(c=>c.id===s);r&&(fe.textContent=r.name),Q.querySelectorAll(".pill").forEach(c=>{c.classList.remove("active"),c.dataset.value===n.difficulty&&c.classList.add("active")}),document.querySelector(".modal-header h3").textContent="Edit Term",he.textContent="Update Term",X.classList.remove("hidden")}function Ct(e){if(!confirm("Are you sure you want to delete this term? This action cannot be undone."))return;const o=E.getTermById(e);if(!o)return;const{categoryId:n}=o;E.deleteTerm(n,e)&&(t.trackEvent("dict_delete_term",{term_id:e,category_id:n}),P===n&&ie(n))}function _t(e){const o=E.getAllCategories().find(s=>s.id===e),n=o?o.name:"this category";confirm(`Are you sure you want to delete "${n}"? All terms in this category will also be deleted. This action cannot be undone.`)&&E.deleteCategory(e)&&(_e(),Ae(),P===e&&(P=null,ne.textContent="Select a Category",q.innerHTML='<div class="empty-state">Select a category from the sidebar to view terms</div>'))}Ue&&Ue.addEventListener("input",e=>{const o=e.target.value.trim();if(o.length>0){A==null||A.querySelectorAll("li").forEach(s=>s.classList.remove("active")),ne.textContent=`Search: "${o}"`;const n=E.searchTerm(o);t.trackEvent("dict_search",{query:o,result_count:n.length}),At(n)}else if(P){const n=E.getAllCategories().find(s=>s.id===P);ne.textContent=n?n.name:"Select a Category",ie(P)}else ne.textContent="Select a Category",q.innerHTML='<div class="empty-state">Select a category from the sidebar to view terms</div>'});function At(e){if(q.innerHTML="",e.length===0){q.innerHTML='<div class="empty-state">No terms found matching your query.</div>';return}e.forEach(o=>{const n=document.createElement("div");n.className="search-category-header",n.textContent=o.categoryName,q.appendChild(n),o.terms.forEach(s=>{const r=et(s);q.appendChild(r)})})}Ze&&Ze.addEventListener("click",()=>{re(),t.trackEvent("dict_contribute_click"),X.classList.remove("hidden")});const ae=document.getElementById("custom-category-dropdown"),tt=document.getElementById("dropdown-trigger"),B=document.getElementById("dropdown-menu"),fe=document.querySelector(".dropdown-value");let R=null;tt&&tt.addEventListener("click",e=>{e.stopPropagation(),ae.classList.toggle("open"),B.classList.toggle("hidden")}),document.addEventListener("click",e=>{ae&&!ae.contains(e.target)&&(ae.classList.remove("open"),B==null||B.classList.add("hidden"))}),Q&&Q.addEventListener("click",e=>{e.target.classList.contains("pill")&&(Q.querySelectorAll(".pill").forEach(o=>o.classList.remove("active")),e.target.classList.add("active"))});function Ae(){if(!B)return;B.innerHTML="",E.getAllCategories().forEach(n=>{const s=document.createElement("div");s.className="dropdown-item",s.dataset.categoryId=n.id,s.textContent=n.name,n.id===R&&s.classList.add("selected"),B.appendChild(s)});const o=document.createElement("div");o.className="dropdown-item new-category-btn",o.innerHTML=`
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Create New Category
        `,B.appendChild(o)}B&&B.addEventListener("click",e=>{const o=e.target.closest(".dropdown-item");if(o){if(o.classList.contains("new-category-btn"))fe.textContent="New Category",R=null,J.classList.remove("hidden"),J.focus();else{const n=o.dataset.categoryId,s=o.textContent;B.querySelectorAll(".dropdown-item").forEach(r=>r.classList.remove("selected")),o.classList.add("selected"),fe.textContent=s,R=n,J.classList.add("hidden")}ae.classList.remove("open"),B.classList.add("hidden")}}),he&&he.addEventListener("click",()=>{const e=document.getElementById("contrib-username").value.trim()||"Anonymous",o=document.getElementById("contrib-term-name").value.trim(),n=document.getElementById("contrib-definition").value.trim(),s=document.getElementById("contrib-examples").value.trim(),r=Q.querySelector(".pill.active"),l=r?r.dataset.value:"beginner";if(!o||!n){showToast("Fields Required","Please fill in both the term name and its definition.","warning");return}const c=s?s.split(",").map(u=>u.trim()):[];if(we&&ee){const u={name:o,definition:n,difficulty:l,examples:c,author:e.replace("@","")};E.editTerm(ee,we,u)&&(P===ee&&ie(ee),re(),X.classList.add("hidden"))}else{let u;if(!R&&!J.classList.contains("hidden")){const p=J.value.trim();if(!p){showToast("Category Name Required","Please enter a name for the new category.","warning");return}u="user_"+p.toLowerCase().replace(/\s+/g,"_"),E.addCategory({id:u,name:p,author:e,terms:[]}),_e(),Ae()}else if(R)u=R;else{showToast("Category Selection Required","Please select a category from the dropdown.","warning");return}const m={id:"user_"+Date.now(),name:o,definition:n,difficulty:l,examples:c,author:e.replace("@",""),likes:0};E.addTerm(u,m),P===u&&ie(u),re(),X.classList.add("hidden")}});function re(){we=null,ee=null,document.querySelector(".modal-header h3").textContent="Contribute a Term",he.textContent="Submit Term",document.getElementById("contrib-username").value="",document.getElementById("contrib-term-name").value="",document.getElementById("contrib-definition").value="",document.getElementById("contrib-examples").value="",J.value="",J.classList.add("hidden"),R=null,fe.textContent="Select a category",Q.querySelectorAll(".pill").forEach(e=>e.classList.remove("active"))}Xe&&Xe.addEventListener("click",()=>{re(),X.classList.add("hidden")}),Qe&&Qe.addEventListener("click",()=>{re(),X.classList.add("hidden")});function qe(){if(!It)return;const e=I.getConfiguredProviders();We.forEach(s=>{const r=s.dataset.provider,l=s.querySelector(".provider-setup-status"),c=s.querySelector(".setup-key-btn");e.includes(r)?(l.textContent="CONFIGURED",l.classList.add("configured"),c.textContent="Update Key"):(l.textContent="NOT CONFIGURED",l.classList.remove("configured"),c.textContent="Setup API Key")}),Ke&&(Ke.style.display=e.length>0?"flex":"none");const o=I.getUsageStats(),n=Object.keys(o).length>0;if(Z==null||Z.classList.toggle("hidden",!n),n&&Z){const s=Z.querySelector(".usage-stats-grid"),r=Z.querySelector(".usage-total-tokens");s.innerHTML="";let l=0;for(const[c,u]of Object.entries(o)){l+=u.requestCount;const m=u.lastUsed?new Date(u.lastUsed).toLocaleDateString():"Never",p=document.createElement("div");p.className="stat-box",p.innerHTML=`
                    <div class="stat-header">
                        <div class="stat-provider">${I.providers[c].name}</div>
                        <div class="stat-indicator"></div>
                    </div>
                    <div class="stat-main">
                        <div class="stat-value">${u.requestCount}<span class="stat-unit">Requests</span></div>
                    </div>
                    <div class="stat-footer">
                        <div class="stat-info">
                            <span>Active Model</span>
                            <span>${u.model||"Default"}</span>
                        </div>
                        <div class="stat-info">
                            <span>Last Used</span>
                            <span>${m}</span>
                        </div>
                    </div>
                `,s.appendChild(p)}r&&(r.textContent=`Total Requests: ${l}`)}}function qt(e){se=e;const o=I.providers[e];document.getElementById("modal-provider-name").textContent=`Configure ${o.name}`,Be.value=I.getProviderKey(e)||"";const n=document.querySelector("#llm-provider-dropdown .dropdown-value");n&&(n.textContent=o.name),document.querySelectorAll("#llm-provider-dropdown .dropdown-item").forEach(l=>{l.classList.toggle("selected",l.dataset.providerId===e)}),U.classList.add("hidden"),U.classList.remove("success","error");const s=document.getElementById("provider-api-key");s.type="password";const r=document.getElementById("toggle-api-key");r&&(r.querySelector(".eye-icon").classList.remove("hidden"),r.querySelector(".eye-off-icon").classList.add("hidden")),document.getElementById("custom-model-group").classList.add("hidden"),document.getElementById("custom-model-id").value="",ot(e),ge.classList.remove("hidden")}function ot(e){const o=document.getElementById("model-dropdown-menu"),n=document.querySelector("#llm-model-dropdown .dropdown-value"),s=document.getElementById("custom-model-group"),r=document.getElementById("custom-model-id"),l=I.providers[e],c=I.config[e],u=(c==null?void 0:c.model)||l.models[0].id,m=l.models.some(w=>w.id===u);o.innerHTML="",l.models.forEach(w=>{const S=document.createElement("div");S.className="dropdown-item",w.id===u&&(S.classList.add("selected"),n.textContent=w.name,F=w.id),S.textContent=w.name,S.dataset.modelId=w.id,S.addEventListener("click",()=>{o.querySelectorAll(".dropdown-item").forEach(C=>C.classList.remove("selected")),S.classList.add("selected"),n.textContent=w.name,F=w.id,s.classList.add("hidden"),document.getElementById("model-dropdown-menu").classList.add("hidden"),document.getElementById("llm-model-dropdown").classList.remove("open")}),o.appendChild(S)});const p=document.createElement("div");p.className="dropdown-item",p.textContent="Custom Model",p.dataset.modelId="custom",m||(p.classList.add("selected"),n.textContent="Custom Model",F="custom",s.classList.remove("hidden"),r.value=u),p.addEventListener("click",()=>{o.querySelectorAll(".dropdown-item").forEach(w=>w.classList.remove("selected")),p.classList.add("selected"),n.textContent="Custom Model",F="custom",s.classList.remove("hidden"),r.focus(),document.getElementById("model-dropdown-menu").classList.add("hidden"),document.getElementById("llm-model-dropdown").classList.remove("open")}),o.appendChild(p)}We.forEach(e=>{e.querySelector(".setup-key-btn").addEventListener("click",()=>{qt(e.dataset.provider)})}),Ve&&Ve.addEventListener("click",()=>ge.classList.add("hidden")),Ye&&Ye.addEventListener("click",()=>ge.classList.add("hidden")),ze&&ze.addEventListener("click",async()=>{const e=Be.value.trim();let o=F;if(!e){showToast("Input Required","Please enter an API key","warning");return}if(F==="custom"){const s=document.getElementById("custom-model-id").value.trim();if(!s){showToast("Input Required","Please enter a custom model ID","warning");return}o=s}U.classList.remove("hidden"),U.innerHTML='<div class="loader-small"></div><span>Validating key...</span>';const n=await I.validateKey(se,e);U.innerHTML=`<span>${n.message}</span>`,U.classList.replace("hidden",n.valid?"success":"error"),n.valid||U.classList.add("error"),t.trackEvent("llm_setup_attempt",{provider:se,success:n.valid,model_type:F==="custom"?"custom":"preset"}),n.valid&&(await I.setProviderKey(se,e,o),setTimeout(()=>{ge.classList.add("hidden"),qe()},1e3))});const Pe=[{triggerId:"provider-dropdown-trigger",menuId:"provider-dropdown-menu",wrapperId:"llm-provider-dropdown"},{triggerId:"model-dropdown-trigger",menuId:"model-dropdown-menu",wrapperId:"llm-model-dropdown"}];Pe.forEach(e=>{const o=document.getElementById(e.triggerId);o&&o.addEventListener("click",n=>{n.stopPropagation(),Pe.forEach(s=>{if(s.triggerId!==e.triggerId){const r=document.getElementById(s.menuId),l=document.getElementById(s.wrapperId);r&&r.classList.add("hidden"),l&&l.classList.remove("open")}}),document.getElementById(e.wrapperId).classList.toggle("open"),document.getElementById(e.menuId).classList.toggle("hidden")})}),document.querySelectorAll("#llm-provider-dropdown .dropdown-item").forEach(e=>{e.addEventListener("click",()=>{const o=e.dataset.providerId,n=e.textContent;document.querySelector("#llm-provider-dropdown .dropdown-value").textContent=n,document.querySelectorAll("#llm-provider-dropdown .dropdown-item").forEach(s=>s.classList.remove("selected")),e.classList.add("selected"),se=o,Be.value=I.getProviderKey(o)||"",ot(o),document.getElementById("provider-dropdown-menu").classList.add("hidden"),document.getElementById("llm-provider-dropdown").classList.remove("open")})}),document.addEventListener("click",()=>{Pe.forEach(e=>{const o=document.getElementById(e.menuId),n=document.getElementById(e.wrapperId);o&&o.classList.add("hidden"),n&&n.classList.remove("open")})}),window.showToast=function(e,o,n="info",s=5e3){const r=document.getElementById("toast-container");if(!r)return;const l=document.createElement("div");l.className=`toast ${n}`;const c=n==="success"?'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>':'<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>';l.innerHTML=`
            <div class="toast-icon">${c}</div>
            <div class="toast-content">
                <div class="toast-title">${e}</div>
                <div class="toast-message">${o}</div>
            </div>
        `,r.appendChild(l),setTimeout(()=>{l.classList.add("hiding"),setTimeout(()=>l.remove(),300)},s)};const $=new Map;function Ne(e,o,n=!1){if(!$.has(e)||n)$.set(e,{stack:[o],index:0});else{const s=$.get(e);s.index<s.stack.length-1&&(s.stack=s.stack.slice(0,s.index+1)),o!==s.stack[s.index]&&(s.stack.push(o),s.index++)}be(e)}function be(e){const o=$.get(e);if(!o)return;const n=e.querySelector(".scene-undo-btn"),s=e.querySelector(".scene-redo-btn");n&&n.classList.toggle("hidden",o.index<=0),s&&s.classList.toggle("hidden",o.index>=o.stack.length-1)}i.addEventListener("input",e=>{if(e.target.classList.contains("scene-description")){const o=e.target.closest(".scene-item"),n=$.get(o);n?(n.stack[n.index]=e.target.value,n.index<n.stack.length-1&&(n.stack=n.stack.slice(0,n.index+1)),be(o)):Ne(o,e.target.value,!0)}}),i&&i.addEventListener("click",async e=>{const o=e.target.closest(".scene-undo-btn");if(o){const m=o.closest(".scene-item"),p=$.get(m);if(p&&p.index>0){p.index--;const w=m.querySelector(".scene-description");w.value=p.stack[p.index],be(m),showToast("Undo","Reverted to previous version","info"),t.trackEvent("undo_enhance")}return}const n=e.target.closest(".scene-redo-btn");if(n){const m=n.closest(".scene-item"),p=$.get(m);if(p&&p.index<p.stack.length-1){p.index++;const w=m.querySelector(".scene-description");w.value=p.stack[p.index],be(m),showToast("Redo","Restored next version","info"),t.trackEvent("redo_enhance")}return}const s=e.target.closest(".scene-enhance-btn");if(!s)return;const r=s.closest(".scene-item");if(!r)return;const l=r.querySelector(".scene-description"),c=I.getConfiguredProviders();if(c.length===0){showToast("Configuration Required","Please configure an AI provider in the integration hub first.","warning");return}const u=c[0];s.classList.add("loading"),s.disabled=!0;try{const m=l.value.trim(),p=r.querySelector(".scene-camera-value").value,w=r.querySelector(".scene-lighting-value").value,S=r.querySelector(".scene-negative-prompt").value.trim();if(!m){showToast("Description Required","Please describe the scene before enhancing.","warning");return}$.has(r)||Ne(r,m,!0);const C={description:m,camera:p||"",lighting:w||"",negative_prompt:S||""},O=k.getParams().platform_preset,te=k.modelService.getProfile(O),H=await I.generatePrompt(u,C,{modelProfile:te});l.value=H,t.trackEnhance(m.length,H.length),Ne(r,H),showToast("Scene Enhanced","AI version added to history stack!","success")}catch(m){console.error("Enhance Error:",m);let p="AI Enhancement Failed",w=m.message;(m.message.toLowerCase().includes("quota")||m.message.toLowerCase().includes("rate limit"))&&(p="Quota Exceeded",w="Wait a moment or switch to Gemini 1.5 Flash."),showToast(p,w,"error")}finally{s.classList.remove("loading"),s.disabled=!1}});const N=document.getElementById("history-modal"),nt=document.getElementById("history-list"),de=document.getElementById("history-preview-code"),le=document.getElementById("history-preview-actions"),st=document.getElementById("history-section-list"),ce=document.getElementById("history-section-preview-code"),ue=document.getElementById("history-section-preview-actions");let K=null;(lt=document.getElementById("history-trigger-btn"))==null||lt.addEventListener("click",()=>{G("modal"),N==null||N.classList.remove("hidden")}),(ct=document.getElementById("history-close-btn"))==null||ct.addEventListener("click",()=>{N==null||N.classList.add("hidden")});const it=()=>{confirm("Are you sure you want to clear all history?")&&(j.clear(),t.trackEvent("history_clear_all"),G("modal"),G("section"),de&&(de.textContent="History cleared."),ce&&(ce.textContent="History cleared."),le&&le.classList.add("hidden"),ue&&ue.classList.add("hidden"),showToast("History Cleared","All recorded versions have been removed.","info"))};(ut=document.getElementById("history-clear-btn"))==null||ut.addEventListener("click",it),(mt=document.getElementById("history-section-clear-btn"))==null||mt.addEventListener("click",it);const at=()=>{if(K){v.value=JSON.stringify(K.content,null,2),N==null||N.classList.add("hidden"),t.trackEvent("history_restore_item",{item_id:K.id});const e=document.querySelector(".main-nav a.active");if((e==null?void 0:e.textContent.trim())==="History"){const o=Array.from(document.querySelectorAll(".main-nav a")).find(n=>n.textContent.trim()==="JSON Generator");o==null||o.click()}document.getElementById("output-section").classList.remove("hidden"),document.getElementById("output-section").scrollIntoView({behavior:"smooth",block:"start"}),showToast("Restored","Version loaded into output editor.","success")}};(pt=document.getElementById("history-restore-btn"))==null||pt.addEventListener("click",at),(vt=document.getElementById("history-section-restore-btn"))==null||vt.addEventListener("click",at);function G(e){const o=j.getAll(),n=e==="modal"?nt:st;if(n){if(n.innerHTML="",o.length===0){n.innerHTML='<div class="empty-state" style="padding: 20px; font-size: 0.85rem;">No history found.</div>';return}o.forEach(s=>{const r=document.createElement("div");r.className="history-item",r.dataset.id=s.id;const l=new Date(s.timestamp),c=l.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),u=l.toLocaleDateString(),m=s.mode==="ai"?"badge-ai":"badge-json",p=s.mode==="ai"?"AI":"JSON";r.innerHTML=`
                <div class="history-item-top">
                    <div class="history-summary">${s.summary||"Generated Prompt"}</div>
                    <span class="history-badge ${m}">${p}</span>
                </div>
                <div class="history-item-bottom">
                    <div class="history-date">${u} ${c}</div>
                    <button class="history-delete-btn" title="Delete Version">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    </button>
                </div>
            `,r.querySelector(".history-delete-btn").addEventListener("click",S=>{S.stopPropagation(),confirm("Delete this version history?")&&(j.delete(s.id),G("modal"),G("section"),K&&K.id===s.id&&(K=null,le&&le.classList.add("hidden"),ue&&ue.classList.add("hidden"),de&&(de.innerHTML='<div class="placeholder-content">Select an item from the sidebar...</div>'),ce&&(ce.innerHTML='<div class="placeholder-content">Select an item from the sidebar...</div>')))}),r.addEventListener("click",()=>Pt(s,r,e)),n.appendChild(r)})}}function Pt(e,o,n){const s=n==="modal"?nt:st;s==null||s.querySelectorAll(".history-item").forEach(c=>c.classList.remove("active")),o.classList.add("active"),K=e;const r=n==="modal"?de:ce,l=n==="modal"?le:ue;l&&l.classList.remove("hidden"),r&&(r.textContent=JSON.stringify(e.content,null,2)),n==="modal"&&window.historysSidebarController&&window.historysSidebarController.close()}window.renderHistoryView=G;const rt=document.getElementById("save-as-template"),dt=document.getElementById("open-template-gallery");rt&&rt.addEventListener("click",()=>{const e=[];i.querySelectorAll(".scene-item").forEach(s=>{var S,C,O,te,H,Se;const r=s.querySelector(".scene-description").value,l=((S=s.querySelector(".scene-camera-input"))==null?void 0:S.value)||"",c=((C=s.querySelector(".scene-lighting-input"))==null?void 0:C.value)||"",u=((O=s.querySelector(".scene-color-input"))==null?void 0:O.value)||"",m=((te=s.querySelector(".scene-mood-input"))==null?void 0:te.value)||"",p=((H=s.querySelector(".scene-sound-input"))==null?void 0:H.value)||"",w=((Se=s.querySelector(".scene-negative-prompt"))==null?void 0:Se.value)||"";e.push({description:r,camera:l,lighting:c,color:u,mood:m,sound:p,customNegative:w})});const n={scenes:e,globalParams:k.getParams()};window.templateUI?window.templateUI.openSaveModal(n):console.error("TemplateUI not found")}),dt&&dt.addEventListener("click",()=>{window.templateUI&&window.templateUI.openGallery()}),window.addEventListener("apply-template",e=>{const o=e.detail;!o||!o.scenes||confirm("Apply this template? Current scenes will be replaced.")&&(i.querySelectorAll(".scene-item").forEach(s=>s.remove()),Y=0,o.scenes.forEach(s=>{a.click();const r=i.lastElementChild;r&&(r.querySelector(".scene-description").value=s.description||"",r.querySelector(".scene-camera-input").value=s.camera||"",r.querySelector(".scene-lighting-input").value=s.lighting||"",r.querySelector(".scene-color-input").value=s.color||"",r.querySelector(".scene-mood-input").value=s.mood||"",r.querySelector(".scene-sound-input").value=s.sound||"",r.querySelector(".scene-negative-prompt").value=s.customNegative||"")}),o.globalParams&&(["aspect_ratio","resolution","frame_rate","platform_preset"].forEach(s=>{o.globalParams[s]&&k.updateParam(s,o.globalParams[s])}),oe()),showToast("Template Applied","Configuration loaded successfully.","success"))})});
